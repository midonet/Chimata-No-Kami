#!/bin/bash

SKEL="stages/skel/fabfile.py"

for STAGE in $(make -rpn | \
    sed -n -e '/^$/ { n ; /^[^ ]*:/p }' | \
    grep -v ^all: | \
    grep -v ^pipinstalled: | \
    grep -v ^pipdeps: | \
    grep -v ^clean: | \
    grep -v ^preflight: | \
    grep -v ^autogenerated: | \
    grep -v 'Chimata-No-Kami/tmp:' | \
    awk '{print $1;}' | \
    sed 's,:,,g' | \
    sort -n | \
    uniq)
do
    AUTOGEN="autogenerated/${STAGE}/fabfile.py"
    FABFILE="stages/${STAGE}/fabfile.py"

    echo "patching ${AUTOGEN}"

    mkdir -pv "$(dirname ${AUTOGEN})"
    mkdir -pv "$(dirname ${FABFILE})"

    #
    # header
    #
    cat "${SKEL}" >"${AUTOGEN}"

    #
    # role definition for fabric
    #
    cat >>"${AUTOGEN}" <<EOF
#
# this code was autogenerated by ${0}.
#
# do not modify it, all changes will be overwritten!
#
@roles('${STAGE}')
def ${STAGE}():
EOF

    if [[ -f "${FABFILE}" ]]; then
        echo "code fragment found for ${AUTOGEN}, adding ${FABFILE}"

        cat >>"${AUTOGEN}" <<EOF
#
# begin of code fragment from ${FABFILE}
#
EOF
        cat "${FABFILE}" >>"${AUTOGEN}"

        cat >>"${AUTOGEN}" <<EOF
#
# end of code fragment from ${FABFILE}
#
EOF

    else
        echo "    pass" >> "${AUTOGEN}"
    fi

    chmod 0755 "${AUTOGEN}"
done

